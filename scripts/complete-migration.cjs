/**
 * Complete Sanity CMS Migration Script (CommonJS)
 * Re≈°ava sve probleme sa shemom i podacima
 */

const { createClient } = require('@sanity/client')
const { v4: uuidv4 } = require('uuid')

// Sanity client configuration
const client = createClient({
  projectId: '08ctxj6y',
  dataset: 'production',
  useCdn: false,
  token: process.env.SANITY_API_TOKEN,
  apiVersion: '2023-10-10'
})

// Helper funkcije
const generateKey = () => uuidv4().replace(/-/g, '').substring(0, 12)

// Srpski sadr≈æaj za razliƒçite sekcije
const SERBIAN_CONTENT = {
  enhancedHero: {
    title: "Pokrenite svoju obrazovnu fran≈°izu sa Sreƒáno uƒçenje",
    subtitle: "Metodologija koja garantuje uspeh",
    description: "Prikljuƒçite se najveƒáoj mre≈æi obrazovnih centara u Srbiji. Na≈°a dokazana metodologija i potpuna podr≈°ka omoguƒáavaju vam da izgradite uspe≈°an posao dok menjate ≈æivote dece u svojoj zajednici.",
    buttons: [
      {
        _key: generateKey(),
        text: "Zapoƒçni fran≈°izu",
        link: "/franchise-form",
        variant: "primary"
      },
      {
        _key: generateKey(),
        text: "Saznaj vi≈°e",
        link: "/o-nama",
        variant: "secondary"
      }
    ]
  },
  
  statistics: [
    {
      _key: generateKey(),
      value: "500+",
      label: "Zadovoljne dece",
      icon: "üë∂"
    },
    {
      _key: generateKey(),
      value: "15+",
      label: "Partnera",
      icon: "ü§ù"
    },
    {
      _key: generateKey(),
      value: "98%",
      label: "Uspe≈°nosti",
      icon: "üìä"
    },
    {
      _key: generateKey(),
      value: "5+",
      label: "Godina iskustva",
      icon: "üéØ"
    }
  ],

  differentiators: {
    sectionTitle: "Za≈°to ba≈° Sreƒáno uƒçenje?",
    items: [
      {
        _key: generateKey(),
        title: "Dokazana metodologija",
        description: "Na≈°a metodologija je testirana sa preko 500 dece i pokazuje izuzetne rezultate u razvoju kognitivnih sposobnosti.",
        icon: "üß†"
      },
      {
        _key: generateKey(),
        title: "Potpuna podr≈°ka",
        description: "Dobijate kompletnu obuku, marketing materijale, tehnolo≈°ku podr≈°ku i kontinuiranu pomoƒá na≈°eg tima.",
        icon: "üéì"
      },
      {
        _key: generateKey(),
        title: "Brz povraƒáaj investicije",
        description: "Proseƒçan ROI od 200% u prvoj godini rada. Poƒçetna investicija se vraƒáa veƒá nakon 8-12 meseci.",
        icon: "üí∞"
      },
      {
        _key: generateKey(),
        title: "Fleksibilni modeli",
        description: "Biraju izmeƒëu razliƒçitih franchise modela koji odgovaraju va≈°im moguƒánostima i ciljevima.",
        icon: "‚ö°"
      }
    ]
  },

  franchiseSteps: {
    sectionTitle: "4 koraka do va≈°e fran≈°ize",
    steps: [
      {
        _key: generateKey(),
        number: "1",
        title: "Aplikacija",
        description: "Popunite online aplikaciju i proƒáiƒáemo kroz va≈°e ciljeve i expectacije.",
        icon: "üìù"
      },
      {
        _key: generateKey(),
        number: "2", 
        title: "Obuka",
        description: "Proƒëite kroz na≈°u sertifikovanu obuku koja traje 2 nedelje i nauƒçite sve o metodologiji.",
        icon: "üéØ"
      },
      {
        _key: generateKey(),
        number: "3",
        title: "Pokretanje",
        description: "Otvorite svoj centar uz na≈°u podr≈°ku za lokaciju, marketing i prve grupe dece.",
        icon: "üöÄ"
      },
      {
        _key: generateKey(),
        number: "4",
        title: "Rast",
        description: "Rastite va≈° posao uz kontinuiranu podr≈°ku, nova deca se prijavljuju meseƒçno.",
        icon: "üìà"
      }
    ]
  },

  franchiseModels: {
    sectionTitle: "Na≈°i modeli",
    models: [
      {
        _key: generateKey(),
        name: "Starter",
        price: "‚Ç¨5,000",
        features: [
          "Osnovna obuka (2 nedelje)",
          "Marketing materijali",
          "6 meseci podr≈°ke",
          "Do 30 dece"
        ],
        highlighted: false
      },
      {
        _key: generateKey(),
        name: "Professional", 
        price: "‚Ç¨12,000",
        features: [
          "Napredna obuka (4 nedelje)",
          "Premium marketing",
          "12 meseci podr≈°ke", 
          "Do 80 dece",
          "Online platforma"
        ],
        highlighted: true
      },
      {
        _key: generateKey(),
        name: "Master",
        price: "‚Ç¨25,000",
        features: [
          "Master obuka (6 nedelja)",
          "Kompletna podr≈°ka", 
          "24 meseca podr≈°ke",
          "Neograniƒçeno dece",
          "Ekskluzivna teritorija"
        ],
        highlighted: false
      }
    ]
  },

  successStories: {
    sectionTitle: "Priƒçe uspeha",
    featuredVideo: "https://www.youtube.com/watch?v=example",
    stories: [
      {
        _key: generateKey(),
        name: "Marija Petroviƒá",
        role: "Vlasnica centra",
        location: "Novi Sad",
        story: "Posle samo 6 meseci rada moj centar ima preko 40 dece. Deca napreduju neverovatno, a ja sam izgradila posao iz snova.",
        yearStarted: "2023",
        metric: {
          value: "40+",
          label: "aktivne dece"
        }
      },
      {
        _key: generateKey(),
        name: "Stefan Jovanoviƒá", 
        role: "Direktor fran≈°ize",
        location: "Kragujevac",
        story: "U prvoj godini rada centar je ostvario prihod od preko ‚Ç¨30,000. Metodologija stvarno radi i roditelji vide rezultate.",
        yearStarted: "2022",
        metric: {
          value: "‚Ç¨30k+",
          label: "godi≈°nji prihod"
        }
      }
    ]
  },

  homeFaqs: {
    sectionTitle: "ƒåesta pitanja"
  },

  interactiveClassroom: {
    sectionTitle: "Interaktivna uƒçionica",
    description: "Posetite na≈°u virtualnu uƒçionicu i vidite kako izgleda jedna tipiƒçna sesija sa decom.",
    ctaText: "Istra≈æite uƒçionicu"
  },

  leadMagnets: {
    sectionTitle: "Besplatni resursi",
    resources: [
      {
        _key: generateKey(),
        title: "Vodiƒç za pokretanje fran≈°ize",
        description: "Kompletna analiza tr≈æi≈°ta i koraci za uspe≈°no pokretanje va≈°e fran≈°ize.",
        downloadUrl: "/downloads/franchise-guide.pdf"
      },
      {
        _key: generateKey(),
        title: "ROI kalkulator",
        description: "Izraƒçunajte potencijalni povraƒáaj investicije za va≈° grad i model fran≈°ize.",
        downloadUrl: "/roi-calculator"
      }
    ]
  },

  newsletterCTA: {
    title: "Budite u toku sa prilikama",
    description: "Prijavite se na newsletter i dobijate ekskluzivne informacije o novim lokacijama, promo cenama i uspesima na≈°ih partnera.",
    incentive: "Besplatan vodiƒç: 10 koraka do uspe≈°ne obrazovne fran≈°ize",
    ctaText: "Prijavite se besplatno"
  },

  seo: {
    metaTitle: "Sreƒáno uƒçenje - Obrazovna fran≈°iza koja garantuje uspeh",
    metaDescription: "Pokrenite uspe≈°nu obrazovnu fran≈°izu sa metodologijom koja je dokazana na preko 500 dece. ROI 200% u prvoj godini.",
    keywords: ["obrazovna fran≈°iza", "fran≈°iza za decu", "Sreƒáno uƒçenje", "edukacija dece", "poslovne prilike"]
  }
}

// FAQ podaci
const FAQ_DATA = [
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq',
    question: "Kolika je poƒçetna investicija za fran≈°izu?",
    answer: "Poƒçetna investicija zavisi od odabranog modela fran≈°ize i kreƒáe se od ‚Ç¨5,000 za Starter model do ‚Ç¨25,000 za Master model. U cenu su ukljuƒçeni obuka, marketing materijali i poƒçetna podr≈°ka.",
    order: 1
  },
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq', 
    question: "Koliko vremena treba da se investicija vrati?",
    answer: "Na osnovu iskustva na≈°ih partnera, poƒçetna investicija se vraƒáa u proseku za 8-12 meseci rada. Neki partneri su postigli povraƒáaj veƒá posle 6 meseci.",
    order: 2
  },
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq',
    question: "Da li je potrebno prethodno iskustvo u radu sa decom?",
    answer: "Nije potrebno prethodno iskustvo. Na≈°a obuka pokriva sve aspekte rada sa decom, metodologiju, upravljanje centrom i marketing. Va≈æni su entuzijazam i ≈æelja za rad sa decom.",
    order: 3
  },
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq',
    question: "Koliko dece mo≈æe da pohaƒëa centar?",
    answer: "Kapacitet zavisi od odabranog modela. Starter model podr≈æava do 30 dece, Professional do 80, dok Master model nema ograniƒçenja. Preporuƒçujemo poƒçetak sa manjim brojem i postepeno pro≈°irenje.",
    order: 4
  },
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq',
    question: "Kakva podr≈°ka se dobija nakon pokretanja centra?",
    answer: "Dobijate kontinuiranu podr≈°ku na≈°eg tima ukljuƒçujuƒái: marketing materijale, pomoƒá sa regrutovanjem dece, struƒçnu podr≈°ku za metodologiju i redovne kontrole kvaliteta rada.",
    order: 5
  },
  {
    _id: `faq-${generateKey()}`,
    _type: 'faq',
    question: "Da li mogu da radim centar uz postojeƒái posao?",
    answer: "Mnogi na≈°i partneri su zapoƒçeli uz postojeƒái posao. Centar mo≈æe da radi popodne/uveƒçe ili vikendom. Sa rastom broja dece, veƒáina partnera prelazi na puno radno vreme.",
    order: 6
  }
]

async function analyzeCurrentData() {
  console.log("üîç Analiziram trenutno stanje podataka...")
  
  try {
    const homePage = await client.fetch('*[_type == "homePage"][0]')
    console.log("üìä HomePage dokument:", homePage ? "POSTOJI" : "NE POSTOJI")
    
    if (homePage) {
      console.log("üîç Polja u homePage dokumentu:")
      Object.keys(homePage).forEach(key => {
        console.log(`  - ${key}: ${typeof homePage[key]}`)
      })

      // Proveri problematiƒçna polja
      const problematicFields = ['freeResources', 'heroSekcija', 'homeFaq']
      problematicFields.forEach(field => {
        if (homePage[field]) {
          console.log(`‚ö†Ô∏è  PRONAƒêENO STARO POLJE: ${field}`)
        }
      })

      // Proveri _key vrednosti u arrays
      if (homePage.statistics && Array.isArray(homePage.statistics)) {
        const hasKeys = homePage.statistics.every(item => item._key)
        console.log(`üìä Statistics _key status: ${hasKeys ? "DODELJENI" : "NEDOSTAJU"}`)
      }
    }

    return homePage
  } catch (error) {
    console.error("‚ùå Gre≈°ka pri analizi:", error)
    return null
  }
}

async function createHomePageDocument() {
  console.log("üìù Kreiram novi homePage dokument...")
  
  const homePageDoc = {
    _id: 'homePage',
    _type: 'homePage',
    
    enhancedHero: {
      _type: 'enhancedHero',
      ...SERBIAN_CONTENT.enhancedHero
    },

    statistics: SERBIAN_CONTENT.statistics,
    
    differentiators: SERBIAN_CONTENT.differentiators,
    
    franchiseSteps: SERBIAN_CONTENT.franchiseSteps,
    
    franchiseModels: SERBIAN_CONTENT.franchiseModels,
    
    successStories: SERBIAN_CONTENT.successStories,
    
    homeFaqs: SERBIAN_CONTENT.homeFaqs,
    
    interactiveClassroom: SERBIAN_CONTENT.interactiveClassroom,
    
    leadMagnets: SERBIAN_CONTENT.leadMagnets,
    
    newsletterCTA: SERBIAN_CONTENT.newsletterCTA,
    
    seo: SERBIAN_CONTENT.seo
  }

  try {
    await client.createOrReplace(homePageDoc)
    console.log("‚úÖ HomePage dokument uspe≈°no kreiran/a≈æuriran!")
    return true
  } catch (error) {
    console.error("‚ùå Gre≈°ka pri kreiranju HomePage:", error)
    return false
  }
}

async function createFAQs() {
  console.log("üìù Kreiram FAQ podatke...")
  
  try {
    // Proveri da li veƒá postoje FAQs
    const existingFAQs = await client.fetch('*[_type == "faq"]')
    
    if (existingFAQs.length > 0) {
      console.log(`‚ÑπÔ∏è Veƒá postoji ${existingFAQs.length} FAQ-ova. Preskaƒçem kreiranje.`)
      return true
    }

    // Kreiraj sve FAQs u batch operaciji
    const transaction = client.transaction()
    
    FAQ_DATA.forEach(faq => {
      transaction.create(faq)
    })
    
    await transaction.commit()
    
    console.log(`‚úÖ Uspe≈°no kreirao ${FAQ_DATA.length} FAQ-ova`)
    return true
    
  } catch (error) {
    console.error("‚ùå Gre≈°ka pri kreiranju FAQ-ova:", error)
    return false
  }
}

async function updateHomePageWithFAQs() {
  console.log("üîó Povezujem FAQs sa HomePage...")
  
  try {
    const faqs = await client.fetch('*[_type == "faq"] | order(order asc) { _id }')
    
    if (faqs.length === 0) {
      console.log("‚ùå Nema FAQ-ova za povezivanje")
      return false
    }

    await client.patch('homePage').set({
      'homeFaqs.faqs': faqs.slice(0, 6).map(faq => ({
        _type: 'reference',
        _ref: faq._id,
        _key: generateKey()
      }))
    }).commit()
    
    console.log(`‚úÖ Povezao ${Math.min(faqs.length, 6)} FAQ-ova sa HomePage`)
    return true
    
  } catch (error) {
    console.error("‚ùå Gre≈°ka pri povezivanju FAQ-ova:", error)
    return false
  }
}

async function cleanupOldFields() {
  console.log("üßπ ƒåistim stara/nepotrebna polja...")
  
  try {
    await client.patch('homePage').unset([
      'freeResources', 'heroSekcija', 'homeFaq'
    ]).commit()
    
    console.log("‚úÖ Stara polja uspe≈°no obrisana")
    return true
  } catch (error) {
    console.error("‚ùå Gre≈°ka pri brisanju starih polja:", error)
    return false
  }
}

async function validateMigration() {
  console.log("üîç Validiram rezultate migracije...")
  
  try {
    const homePage = await client.fetch(`
      *[_type == "homePage"][0] {
        _id,
        enhancedHero,
        statistics,
        differentiators,
        franchiseSteps,
        franchiseModels,
        successStories,
        homeFaqs,
        interactiveClassroom,
        leadMagnets,
        newsletterCTA,
        seo
      }
    `)

    if (!homePage) {
      console.error("‚ùå HomePage dokument ne postoji!")
      return false
    }

    console.log("‚úÖ Validacija - HomePage dokument postoji")

    // Proveri da li postoje potrebne sekcije
    const requiredSections = [
      'enhancedHero', 'statistics', 'differentiators', 
      'franchiseSteps', 'franchiseModels', 'successStories',
      'homeFaqs', 'interactiveClassroom', 'leadMagnets', 'newsletterCTA'
    ]

    let allSectionsPresent = true
    requiredSections.forEach(section => {
      if (homePage[section]) {
        console.log(`‚úÖ ${section}: POSTOJI`)
      } else {
        console.log(`‚ùå ${section}: NEDOSTAJE`)
        allSectionsPresent = false
      }
    })

    // Proveri _key vrednosti
    if (homePage.statistics && Array.isArray(homePage.statistics)) {
      const allHaveKeys = homePage.statistics.every(item => item._key)
      console.log(`‚úÖ Statistics _key: ${allHaveKeys ? "SVI IMAJU" : "NEDOSTAJU"}`)
    }

    // Proveri FAQ count
    const faqCount = await client.fetch('count(*[_type == "faq"])')
    console.log(`‚úÖ FAQ dokumenti: ${faqCount} kreirano`)

    console.log(`\nüéØ REZULTAT VALIDACIJE: ${allSectionsPresent && faqCount > 0 ? "USPE≈†NO" : "NEISPRAVNO"}`)
    return allSectionsPresent && faqCount > 0

  } catch (error) {
    console.error("‚ùå Gre≈°ka pri validaciji:", error)
    return false
  }
}

async function runCompleteMigration() {
  console.log("üöÄ POKRETAM KOMPLETNU SANITY MIGRACIJU")
  console.log("=" .repeat(50))
  
  try {
    // 1. Analiziraj trenutno stanje
    const currentData = await analyzeCurrentData()
    
    // 2. Kreiraj/a≈æuriraj HomePage
    const homePageSuccess = await createHomePageDocument()
    if (!homePageSuccess) {
      throw new Error("HomePage kreiranje neuspe≈°no")
    }
    
    // 3. Kreiraj FAQs
    const faqSuccess = await createFAQs()
    if (!faqSuccess) {
      throw new Error("FAQ kreiranje neuspe≈°no")
    }

    // 4. Povezuj FAQs sa HomePage
    const linkSuccess = await updateHomePageWithFAQs()
    if (!linkSuccess) {
      throw new Error("FAQ povezivanje neuspe≈°no")
    }
    
    // 5. Oƒçisti stara polja
    await cleanupOldFields()
    
    // 6. Validacija
    const validationSuccess = await validateMigration()
    if (!validationSuccess) {
      throw new Error("Validacija neuspe≈°na")
    }

    console.log("\n" + "=" .repeat(50))
    console.log("üéâ MIGRACIJA USPE≈†NO ZAVR≈†ENA!")
    console.log("‚úÖ Svi problemi su re≈°eni:")
    console.log("  - Unknown fields uklonjeni")  
    console.log("  - _key vrednosti dodeljene")
    console.log("  - Struktura a≈æurirana")
    console.log("  - Srpski sadr≈æaj popunjen")
    console.log("  - FAQ podaci kreirani")
    console.log("=" .repeat(50))
    
    return true

  } catch (error) {
    console.error("\n‚ùå MIGRACIJA NEUSPE≈†NA:", error.message)
    return false
  }
}

// Pokreni migraciju
runCompleteMigration()
  .then(success => {
    process.exit(success ? 0 : 1)
  })
  .catch(error => {
    console.error("üí• Neoƒçekivana gre≈°ka:", error)
    process.exit(1)
  })